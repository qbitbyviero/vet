<!-- clientes.html: M√≥dulo de Clientes üêæ completo (modal optimizado) -->
<div class="modal-clientes-overlay" onclick="cerrarModalClientes(event)">
  <div class="modal-clientes" onclick="event.stopPropagation()">
    <button class="cerrar-modal" onclick="cerrarModalClientes()">‚úñ</button>
    <h2>Registro de Cliente üêæ</h2>

    <!-- Campo de b√∫squeda tipo dropdown -->
    <div style="margin-bottom: 1em;">
      <label for="searchPet">Selecciona mascota registrada:</label>
      <select id="searchPet" onchange="seleccionarClienteDesdeLista()">
        <option value="">-- Buscar mascota existente --</option>
      </select>
    </div>

    <form id="form-clientes">
      <!-- Datos del Propietario -->
      <fieldset>
        <legend>Datos del Propietario</legend>
        <div class="grid-two-cols">
          <div class="form-group">
            <label for="ownerName">Nombre Completo:</label>
            <input type="text" id="ownerName" name="ownerName" required />
          </div>
          <div class="form-group">
            <label for="ownerPhone">Tel√©fono:</label>
            <input type="tel" id="ownerPhone" name="ownerPhone" required />
          </div>
          <div class="form-group">
            <label for="ownerEmail">Correo Electr√≥nico:</label>
            <input type="email" id="ownerEmail" name="ownerEmail" required />
          </div>
        </div>
      </fieldset>

      <!-- Datos de la Mascota -->
      <fieldset>
        <legend>Datos de la Mascota</legend>
        <div class="grid-two-cols">
          <div class="form-group">
            <label for="petName">Nombre Mascota:</label>
            <input type="text" id="petName" name="petName" required />
          </div>
          <div class="form-group">
            <label for="pet-species">Especie:</label>
            <select id="pet-species" name="species" required onchange="cargarDiagramaCliente()">
              <option value="">-- Selecciona --</option>
              <option value="perro">Perro</option>
              <option value="gato">Felino</option>
              <option value="ave">Ave</option>
              <option value="tortuga">Tortuga</option>
              <option value="serpiente">Serpiente</option>
              <option value="lagarto">Lagarto</option>
              <option value="pez">Pez</option>
              <option value="roedor">Roedor</option>
            </select>
          </div>
          <div class="form-group">
            <label for="breed">Raza:</label>
            <input type="text" id="breed" name="breed" />
          </div>
          <div class="form-group">
            <label for="age">Edad (a√±os):</label>
            <input type="number" id="age" name="age" min="0" step="1" />
          </div>
          <div class="form-group">
            <label for="weight">Peso (kg):</label>
            <input type="number" id="weight" name="weight" min="0" step="0.1" />
          </div>
          <div class="form-group">
            <label>¬øEst√° esterilizado?</label>
            <div class="radio-group">
              <label><input type="radio" name="sterilized" value="si" /> S√≠</label>
              <label><input type="radio" name="sterilized" value="no" /> No</label>
            </div>
          </div>
        </div>

        <!-- Diagrama Corporal con hotspots -->
        <div id="cliente-diagrama" class="diagrama-container">
          <img id="diagrama-img" src="" alt="Diagrama mascota" />
        </div>
      </fieldset>

      <button type="submit" class="button-86" id="btnGuardarCliente">Guardar Cliente</button>
    </form>
  </div>
</div>

<style>
  .modal-clientes-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-clientes {
    background: white;
    padding: 1em;
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    position: relative;
    overflow-y: auto;
    max-height: 95vh;
  }
  .cerrar-modal {
    position: absolute;
    top: 0.4em;
    right: 0.6em;
    border: none;
    background: none;
    font-size: 1.5em;
    cursor: pointer;
  }
</style>

<script>
  function cerrarModalClientes(e) {
    if (!e || e.target.classList.contains('modal-clientes-overlay')) {
      document.querySelector('.modal-clientes-overlay')?.remove();
    }
  }

  const mapaImagen = {
    perro: 'svg/perro.png',
    gato: 'svg/felino.svg',
    ave: 'svg/ave.png',
    tortuga: 'svg/tortuga.svg',
    serpiente: 'svg/serpiente.svg',
    lagarto: 'svg/lagarto.png',
    pez: 'svg/pez.svg',
    roedor: 'svg/roedor.svg'
  };

  const img = document.getElementById('diagrama-img');
  const cont = document.getElementById('cliente-diagrama');

  function cargarDiagramaCliente() {
    const especie = document.getElementById('pet-species').value;
    const src = mapaImagen[especie] || '';
    img.src = src;
    clearHotspots();
    if (src) {
      img.onload = () => { cont.style.minHeight = img.offsetHeight + 'px'; };
      cont.addEventListener('click', addHotspot);
    } else {
      cont.removeEventListener('click', addHotspot);
    }
  }

  function addHotspot(e) {
    const rect = cont.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const dot = document.createElement('div');
    dot.className = 'hotspot';
    dot.style.left = (x - 10) + 'px';
    dot.style.top = (y - 10) + 'px';
    cont.appendChild(dot);
  }

  function clearHotspots() {
    cont.querySelectorAll('.hotspot').forEach(h => h.remove());
  }

  let mascotasGlobal = [];

  async function seleccionarClienteDesdeLista() {
    const valor = document.getElementById("searchPet").value;
    if (!valor) return;
    if (mascotasGlobal.length === 0) mascotasGlobal = await window.loadAllClients();
    const cliente = mascotasGlobal.find(c => c["Nombre de la mascota"] === valor);
    if (cliente) llenarFormularioCliente(cliente);
  }

  function llenarFormularioCliente(result) {
    document.getElementById("ownerName").value  = result["Nombre del propietario"] || "";
    document.getElementById("ownerPhone").value = result["N√∫mero de Tel√©fono"] || "";
    document.getElementById("ownerEmail").value = result["Correo"] || "";
    document.getElementById("petName").value    = result["Nombre de la mascota"] || "";
    document.getElementById("pet-species").value= result["Especie"] || "";
    document.getElementById("breed").value      = result["Raza"] || "";
    document.getElementById("age").value        = result["Edad"] || "";
    document.getElementById("weight").value     = result["Peso"] || "";

    const est = (result["Esterilizado"] || "").toLowerCase();
    if (est === "s√≠" || est === "si") {
      document.querySelector('input[name="sterilized"][value="si"]').checked = true;
    } else if (est === "no") {
      document.querySelector('input[name="sterilized"][value="no"]').checked = true;
    }

    cargarDiagramaCliente();
    const btn = document.getElementById("btnGuardarCliente");
    btn.disabled = true;
    btn.textContent = "Cliente ya registrado";
  }

  document.addEventListener("DOMContentLoaded", async () => {
    if (typeof window.loadAllClients === "function") {
      mascotasGlobal = await window.loadAllClients();
      const select = document.getElementById("searchPet");
      mascotasGlobal.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c["Nombre de la mascota"];
        opt.textContent = c["Nombre de la mascota"];
        select.appendChild(opt);
      });
    }
  });
</script>
