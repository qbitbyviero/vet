<!-- clientes.html FUNCIONAL Y LIMPIO -->
<div class="modal-clientes">
  <h2>Registro de Cliente üêæ</h2>

  <!-- Dropdown b√∫squeda de mascota existente -->
  <div style="margin-bottom: 1em;">
    <label for="searchPet">Selecciona mascota registrada:</label>
    <select id="searchPet">
      <option value="">-- Buscar mascota existente --</option>
    </select>
  </div>

  <form id="form-clientes">
    <!-- Datos del Propietario -->
    <fieldset>
      <legend>Datos del Propietario</legend>
      <div class="grid-two-cols">
        <div class="form-group">
          <label for="ownerName">Nombre del propietario:</label>
          <input type="text" id="ownerName" required />
        </div>
        <div class="form-group">
          <label for="ownerPhone">N√∫mero de Tel√©fono:</label>
          <input type="tel" id="ownerPhone" required />
        </div>
        <div class="form-group">
          <label for="ownerEmail">Correo:</label>
          <input type="email" id="ownerEmail" required />
        </div>
      </div>
    </fieldset>

    <!-- Datos de la Mascota -->
    <fieldset>
      <legend>Datos de la Mascota</legend>
      <div class="grid-two-cols">
        <div class="form-group">
          <label for="petName">Nombre de la mascota:</label>
          <input type="text" id="petName" required />
        </div>
        <div class="form-group">
          <label for="pet-species">Especie:</label>
          <select id="pet-species" required>
            <option value="">-- Selecciona --</option>
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="ave">Ave</option>
            <option value="tortuga">Tortuga</option>
            <option value="serpiente">Serpiente</option>
            <option value="lagarto">Lagarto</option>
            <option value="pez">Pez</option>
            <option value="roedor">Roedor</option>
          </select>
        </div>
        <div class="form-group">
          <label for="breed">Raza:</label>
          <select id="breed" required>
            <option value="">-- Selecciona especie primero --</option>
          </select>
          <input type="text" id="breed-other" placeholder="Especificar otra raza" style="display:none; margin-top:5px;" />
        </div>
        <div class="form-group">
          <label for="age">Edad (a√±os):</label>
          <input type="number" id="age" step="0.1" min="0" />
        </div>
        <div class="form-group">
          <label for="weight">Peso (kg):</label>
          <input type="number" id="weight" step="0.01" min="0" />
        </div>
        <div class="form-group">
          <label>¬øEst√° esterilizado?</label>
          <label><input type="radio" name="sterilized" value="si" /> S√≠</label>
          <label><input type="radio" name="sterilized" value="no" /> No</label>
        </div>
      </div>

      <div class="form-group">
        <label for="observations">Observaciones:</label>
        <textarea id="observations" rows="2"></textarea>
      </div>

      <div id="cliente-diagrama" class="diagrama-container">
        <img id="diagrama-img" src="svg/placeholder.png" alt="Diagrama mascota" />
      </div>
    </fieldset>

    <button type="submit" class="button-86">Guardar Cliente</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const especieSelect = document.getElementById("pet-species");
  const razaSelect = document.getElementById("breed");
  const razaOther = document.getElementById("breed-other");
  const diagramaImg = document.getElementById("diagrama-img");
  const searchPet = document.getElementById("searchPet");

  const especiesRazas = {
    perro: ["Criollo", "Bulldog", "Chihuahua", "Pastor Alem√°n", "Labrador", "Pug", "Otro"],
    gato: ["Criollo", "Persa", "Siam√©s", "Maine Coon", "Bengala", "Otro"],
    ave: ["Canario", "Periquito", "Loro", "Cotorra", "Otro"],
    tortuga: ["Orejas Rojas", "Caja", "Leopardo", "Sulcata", "Otro"],
    serpiente: ["Pit√≥n", "Boa", "Ma√≠z", "Otro"],
    lagarto: ["Iguana", "Gecko", "Otro"],
    pez: ["Betta", "Goldfish", "Otro"],
    roedor: ["H√°mster", "Cuy", "Rat√≥n", "Conejo", "Otro"]
  };

  const especieImg = {
    perro: "svg/perro.png",
    gato: "svg/felino.svg",
    ave: "svg/ave.png",
    tortuga: "svg/tortuga.svg",
    serpiente: "svg/serpiente.svg",
    lagarto: "svg/lagarto.png",
    pez: "svg/pez.svg",
    roedor: "svg/roedor.svg"
  };

  async function cargarClientes() {
    const clientes = await window.loadAllClients();
    clientes.forEach(c => {
      if (c["Nombre de la mascota"]) {
        const opt = document.createElement("option");
        opt.value = c["Nombre de la mascota"];
        opt.textContent = `${c["Nombre de la mascota"]} (${c["Nombre del propietario"]})`;
        searchPet.appendChild(opt);
      }
    });

    searchPet.addEventListener("change", () => {
      const selected = clientes.find(c => c["Nombre de la mascota"] === searchPet.value);
      if (!selected) return;

      document.getElementById("ownerName").value = selected["Nombre del propietario"] || "";
      document.getElementById("ownerPhone").value = selected["N√∫mero de Tel√©fono"] || "";
      document.getElementById("ownerEmail").value = selected["Correo"] || "";
      document.getElementById("petName").value = selected["Nombre de la mascota"] || "";
      document.getElementById("age").value = selected["Edad"] || "";
      document.getElementById("weight").value = selected["Peso"] || "";
      document.getElementById("observations").value = selected["Observaciones"] || "";

      const especie = selected["Especie"]?.toLowerCase();
      especieSelect.value = especie || "";
      actualizarRazas(especie);
      razaSelect.value = selected["Raza"] || "";
      diagramaImg.src = especieImg[especie] || "svg/placeholder.png";

      const est = (selected["Esterilizado"] || "").toLowerCase();
      document.querySelector(`input[name='sterilized'][value='${est === "s√≠" || est === "si" ? "si" : "no"}']`).checked = true;
    });
  }

  function actualizarRazas(especie) {
    razaSelect.innerHTML = `<option value="">-- Selecciona raza --</option>`;
    if (!especie || !especiesRazas[especie]) return;
    especiesRazas[especie].forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      razaSelect.appendChild(opt);
    });
  }

  especieSelect.addEventListener("change", () => {
    actualizarRazas(especieSelect.value);
    diagramaImg.src = especieImg[especieSelect.value] || "svg/placeholder.png";
  });

  razaSelect.addEventListener("change", () => {
    razaOther.style.display = razaSelect.value === "Otro" ? "block" : "none";
  });

  cargarClientes();
});
</script>

<style>
.modal-clientes {
  background: white;
  padding: 1em;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  max-height: 95vh;
  overflow-y: auto;
}
.grid-two-cols {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1em;
}
.form-group {
  display: flex;
  flex-direction: column;
}
.diagrama-container img {
  max-width: 100%;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 1em;
}
.button-86 {
  margin-top: 1em;
  padding: 0.5em 1em;
  background: #0d47a1;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
</style>
