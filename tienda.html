<!-- tienda.html: Módulo de Tienda 🛒 unificado -->

<div class="modal-tienda">
  <h2>Tienda Online 🛒</h2>

  <!-- Productos (estáticos + dinámicos) -->
  <div class="product-grid" id="product-grid">
    <!-- Cada tarjeta de producto -->
    <div class="product-card">
      <img src="https://via.placeholder.com/150" alt="Shampoo de Aloe" />
      <h4>Shampoo de Aloe</h4>
      <p class="price">$120.00</p>
      <button class="button-86 add-to-cart" data-product-id="1">Agregar</button>
    </div>

    <div class="product-card">
      <img src="https://via.placeholder.com/150" alt="Cepillo para Mascotas" />
      <h4>Cepillo para Mascotas</h4>
      <p class="price">$85.50</p>
      <button class="button-86 add-to-cart" data-product-id="2">Agregar</button>
    </div>

    <div class="product-card">
      <img src="https://via.placeholder.com/150" alt="Jabón Antipulgas" />
      <h4>Jabón Antipulgas</h4>
      <p class="price">$150.00</p>
      <button class="button-86 add-to-cart" data-product-id="3">Agregar</button>
    </div>

    <div class="product-card">
      <img src="https://via.placeholder.com/150" alt="Loción Hidratante" />
      <h4>Loción Hidratante</h4>
      <p class="price">$95.75</p>
      <button class="button-86 add-to-cart" data-product-id="4">Agregar</button>
    </div>
  </div>

  <!-- Formulario de Cliente y Descuento -->
  <div class="checkout-form">
    <h3>Detalles de la Compra</h3>

    <label for="cliente-name">Nombre del Cliente:</label>
    <input type="text" id="cliente-name" placeholder="Nombre completo..." />

    <label for="discount-type">Descuento:</label>
    <div class="discount-row">
      <select id="discount-type">
        <option value="percent">Porcentaje (%)</option>
        <option value="fixed">Descuento Fijo ($)</option>
        <option value="coupon">Cupón ($)</option>
        <option value="promo">Promoción</option>
      </select>
      <input type="number" id="discount-value" placeholder="0" min="0" />
      <button type="button" class="button-86" id="apply-discount">Aplicar</button>
    </div>
  </div>
</div>

<!-- Carrito Flotante (aparece automáticamente cuando cargas tienda) -->
<div id="cart" class="cart open">
  <h3>Carrito</h3>
  <ul id="cart-items"></ul>
  <p>Subtotal: $<span id="cart-subtotal">0.00</span></p>
  <p>Descuento: $<span id="cart-discount">0.00</span></p>
  <p class="cart-promo" style="font-style:italic;color:#0d47a1;"></p>
  <p><strong>Total: $<span id="cart-total">0.00</span></strong></p>
  <button type="button" class="button-86" id="checkout">Finalizar Compra</button>
</div>

<script>
  // Misma lógica de JS que ya tienes, pero asegúrate de que 'fetch' use la ruta '/vet/...'
  // (Ver explicación del path en el anterior mensaje)

  // Datos de prueba
  const products = [
    { id: 1, name: 'Shampoo de Aloe', image: 'https://via.placeholder.com/150', price: 120.00 },
    { id: 2, name: 'Cepillo para Mascotas', image: 'https://via.placeholder.com/150', price: 85.50 },
    { id: 3, name: 'Jabón Antipulgas', image: 'https://via.placeholder.com/150', price: 150.00 },
    { id: 4, name: 'Loción Hidratante', image: 'https://via.placeholder.com/150', price: 95.75 }
  ];
  const cart = [];
  const cartEl = document.getElementById('cart');
  const cartItemsEl = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('cart-subtotal');
  const discountEl = document.getElementById('cart-discount');
  const promoEl = document.querySelector('.cart-promo');
  const totalEl = document.getElementById('cart-total');
  const discountTypeEl = document.getElementById('discount-type');
  const discountValueEl = document.getElementById('discount-value');

  // Función para actualizar visual del carrito
  function updateCart() {
    cartItemsEl.innerHTML = '';
    let subtotal = 0;
    cart.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.name} x${item.qty}`;
      const btn = document.createElement('button');
      btn.className = 'button-86 btn-remove';
      btn.textContent = '×';
      btn.onclick = () => removeFromCart(item.id);
      li.appendChild(btn);
      cartItemsEl.appendChild(li);
      subtotal += item.price * item.qty;
    });
    subtotalEl.textContent = subtotal.toFixed(2);
    applyDiscount();
  }

  // Añadir producto al carrito
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.onclick = () => {
      const prodId = parseInt(btn.dataset.productId);
      const product = products.find(p => p.id === prodId);
      const existing = cart.find(i => i.id === prodId);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ ...product, qty: 1 });
      }
      updateCart();
      cartEl.classList.add('open'); // Asegura que el carrito esté visible
    };
  });

  // Quitar producto del carrito
  function removeFromCart(id) {
    const idx = cart.findIndex(i => i.id === id);
    if (idx !== -1) cart.splice(idx, 1);
    updateCart();
  }

  // Aplicar descuento o promoción
  function applyDiscount() {
    const subtotal = parseFloat(subtotalEl.textContent);
    const type = discountTypeEl.value;
    let val = discountValueEl.value;
    let discountAmt = 0;
    promoEl.textContent = '';
    if (type === 'percent') {
      discountAmt = subtotal * (parseFloat(val) / 100 || 0);
    } else if (type === 'fixed' || type === 'coupon') {
      discountAmt = parseFloat(val) || 0;
    } else if (type === 'promo') {
      promoEl.textContent = val || '';
      discountAmt = 0;
    }
    discountEl.textContent = discountAmt.toFixed(2);
    totalEl.textContent = (subtotal - discountAmt).toFixed(2);
  }

  discountTypeEl.onchange = () => {
    if (discountTypeEl.value === 'promo') {
      discountValueEl.type = 'text';
      discountValueEl.placeholder = 'Texto de promoción';
      discountValueEl.value = '';
    } else {
      discountValueEl.type = 'number';
      discountValueEl.placeholder = '0';
      discountValueEl.value = '';
    }
  };

  document.getElementById('apply-discount').onclick = applyDiscount;

  // Finalizar compra (simulado)
  document.getElementById('checkout').onclick = () => {
    const name = document.getElementById('cliente-name').value || '---';
    alert(`Compra finalizada!\nCliente: ${name}\nTotal: $${totalEl.textContent}`);
    cart.length = 0;
    updateCart();
    document.getElementById('cliente-name').value = '';
    discountValueEl.value = '';
    promoEl.textContent = '';
  };

  // Hacer que el carrito sea arrastrable
  (function() {
    const cartDiv = document.getElementById('cart');
    let dragging = false, startX, startY, origX, origY;
    cartDiv.addEventListener('mousedown', e => {
      dragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = cartDiv.getBoundingClientRect();
      origX = rect.left;
      origY = rect.top;
      cartDiv.style.transition = 'none';
      cartDiv.classList.remove('open');
      e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      cartDiv.style.position = 'fixed';
      cartDiv.style.left = origX + (e.clientX - startX) + 'px';
      cartDiv.style.top = origY + (e.clientY - startY) + 'px';
    });
    document.addEventListener('mouseup', () => dragging = false);
  })();

  // Inicializar carrito vacío
  updateCart();
</script>
