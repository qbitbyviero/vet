<!-- consulta.html: M√≥dulo de Consulta Veterinaria ü©∫ -->
<div class="modal-consulta">
  <h2>Consulta Veterinaria ü©∫</h2>
  <form id="form-consulta">
    <!-- Secci√≥n de b√∫squeda o nueva consulta -->
    <fieldset>
      <legend>Identificaci√≥n de Mascota</legend>
      <label><input type="radio" name="consultaType" value="existente" checked /> Consulta existente</label>
      <label><input type="radio" name="consultaType" value="nueva" /> Consulta nueva (cliente y mascota)</label>
      <div id="consulta-existente">
        <label>Nombre de la Mascota:</label>
        <input type="text" id="consulta-petName" placeholder="Ingresar nombre..." />
        <button type="button" class="button-86" id="buscar-consulta">Buscar</button>
        <div id="consulta-result"></div>
      </div>
      <div id="consulta-nueva" style="display:none; margin-top:1em;">
        <h4>Datos Propietario</h4>
        <label>Nombre:</label><input type="text" name="ownerName" />
        <label>Tel√©fono:</label><input type="tel" name="ownerPhone" />
        <label>Correo:</label><input type="email" name="ownerEmail" />
        <h4>Datos Mascota</h4>
        <label>Nombre Mascota:</label><input type="text" name="petNameNew" />
        <label>Especie:</label><input type="text" name="speciesNew" />
        <label>Raza:</label><input type="text" name="breedNew" />
      </div>
    </fieldset>

    <!-- Diagrama -->
    <fieldset>
      <legend>Diagrama de Tratamiento</legend>
      <div id="consulta-diagrama" class="diagrama-container">
        <img id="consulta-diagrama-img" src="" alt="Diagrama Mascota" />
      </div>
    </fieldset>

    <!-- Signos vitales y s√≠ntomas -->
    <fieldset>
      <legend>Signos Vitales y S√≠ntomas</legend>
      <label>Edad (a√±os):</label><input type="number" name="age" min="0" />
      <label>Peso (kg):</label><input type="number" name="weight" step="0.1" />
      <label>Frecuencia Card√≠aca (lpm):</label><input type="number" name="heartRate" />
      <label>Temperatura (¬∞C):</label><input type="number" name="temperature" step="0.1" />
      <label>Condici√≥n del Manto:</label>
      <select name="coatCondition">
        <option value="normal">Normal</option>
        <option value="seco">Seco</option>
        <option value="graso">Graso</option>
        <option value="da√±ado">Da√±ado</option>
      </select>
      <label>S√≠ntomas Observados:</label><textarea name="symptoms" rows="3"></textarea>
    </fieldset>

    <!-- Diagn√≥stico final -->
    <fieldset>
      <legend>Evaluaci√≥n y Plan M√©dico üßæ</legend>
      <label>Diagn√≥stico Presuntivo/Definitivo:</label><textarea name="diagnosticoFinal" rows="2" /></textarea>
      <label>Pruebas Realizadas:</label><textarea name="pruebas" rows="2" /></textarea>
      <label>Medicaci√≥n Prescrita:</label><textarea name="medicacion" rows="2" /></textarea>
      <label>Recomendaciones:</label><textarea name="recomendaciones" rows="2" /></textarea>
      <label>Pr√≥ximo Control:</label><input type="date" name="proximoControl" />
    </fieldset>

    <!-- Medicamentos y precios -->
    <fieldset>
      <legend>Medicamentos Administrados</legend>
      <p class="notice">Una patita amiga siempre ayuda: la consulta, por cuenta de la casa üêæ</p>
      <table id="tabla-meds-consulta">
        <thead>
          <tr><th>Medicamento</th><th>Dosificaci√≥n</th><th>V√≠a</th><th>Precio</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><select name="medicamento[]" class="med-select"></select></td>
            <td><input type="text" name="dosage[]" placeholder="100 ml" /></td>
            <td><select name="route[]"><option>Oral</option><option>Intravenoso</option><option>Intramuscular</option><option>T√≥pico</option></select></td>
            <td class="price-cell">$0.00</td>
            <td><button type="button" class="button-86 btn-remove">Eliminar</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="button-86" id="add-med">A√±adir Medicamento</button>
      <div class="total-consulta"><strong>Total:</strong> $<span id="total-consulta">0.00</span></div>
    </fieldset>

    <!-- Botones y vista previa receta -->
    <button type="button" class="button-86" id="toggle-avanzado">üß¨ Consulta Detallada</button>
    <button type="button" class="button-86" id="preview-receta">Vista Previa Receta</button>
    <button type="submit" class="button-86">Guardar Consulta</button>
  </form>

  <!-- Secci√≥n Avanzada (escondida inicialmente) -->
  <div id="seccion-avanzada" style="display:none; margin-top:1em;">
    <fieldset>
      <legend>Historial Cl√≠nico Adicional üìã</legend>
      <label>Motivo de Consulta:</label><textarea name="motivoConsulta" rows="2"></textarea>
      <label>Historial M√©dico Previo:</label><textarea name="historialMedico" rows="2"></textarea>
      <label>Vacunaci√≥n:</label><input type="text" name="vacunacion" placeholder="Ej: Al d√≠a - 10/07/2025" />
      <label>Desparasitaci√≥n:</label><input type="text" name="desparasitacion" placeholder="Ej: Endogard - 15/06/2025" />
      <label>Alimentaci√≥n:</label><input type="text" name="alimentacion" placeholder="Ej: Croquetas, dieta barf..." />
      <label>Estado Corporal (1-9):</label><input type="number" name="estadoCorporal" min="1" max="9" />
      <label>Hidrataci√≥n (% o descripci√≥n):</label><input type="text" name="hidratacion" />
      <label>Mucosas:</label><input type="text" name="mucosas" />
      <label>TRC (segundos):</label><input type="number" name="trc" />
      <label>FR (rpm):</label><input type="number" name="fr" />
      <label>Auscultaci√≥n Card√≠aca/Pulmonar:</label><textarea name="auscultacion"></textarea>
      <label>Ojos/O√≠dos:</label><textarea name="ojosOidos"></textarea>
      <label>Boca:</label><textarea name="boca"></textarea>
      <label>Abdomen:</label><textarea name="abdomen"></textarea>
      <label>Ganglios:</label><textarea name="ganglios"></textarea>
      <label>V√≥mitos / Regurgitaci√≥n:</label><textarea name="vomitos"></textarea>
      <label>Diarrea / Estre√±imiento:</label><textarea name="diarrea"></textarea>
      <label>Tos / Estornudos:</label><textarea name="tos"></textarea>
      <label>Cojera:</label><textarea name="cojera"></textarea>
      <label>Orina / Sed:</label><textarea name="orinaSed"></textarea>
      <label>Dolor (Escala 1-5):</label><input type="number" name="dolor" min="1" max="5" />
      <label>Cambios de Comportamiento:</label><textarea name="comportamiento"></textarea>
      <label>Presi√≥n Arterial:</label><input type="text" name="presion" />
      <label>Sat O‚ÇÇ:</label><input type="text" name="oxigeno" />
      <label>Glucosa (mg/dL):</label><input type="number" name="glucosa" />
      <label>Reflejos Neurol√≥gicos:</label><textarea name="reflejos"></textarea>
    </fieldset>
  </div>

  <div id="receta-container" style="display:none; margin-top:1em; border:1px solid #0277bd;"></div>
</div>

<script>
  // Mostrar/ocultar secciones seg√∫n tipo de consulta
  document.querySelectorAll('input[name="consultaType"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('consulta-existente').style.display =
        r.value === 'existente' && r.checked ? 'block' : 'none';
      document.getElementById('consulta-nueva').style.display =
        r.value === 'nueva' && r.checked ? 'block' : 'none';
    };
  });

  // Mostrar diagrama seg√∫n especie (simulado)
  const mapaDiag = {
    perro: 'svg/perro.png',
    gato: 'svg/felino.svg',
    ave: 'svg/ave.png',
    tortuga: 'svg/tortuga.svg',
    serpiente: 'svg/serpiente.svg',
    lagarto: 'svg/lagarto.png',
    pez: 'svg/pez.svg',
    roedor: 'svg/roedor.svg'
  };
  const diagImg = document.getElementById('consulta-diagrama-img');
  const diagCont = document.getElementById('consulta-diagrama');
  function clearHotspots() {
    diagCont.querySelectorAll('.hotspot').forEach(h => h.remove());
  }
  function addHotspot(e) {
    const r = diagCont.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    const d = document.createElement('div');
    d.className = 'hotspot';
    d.style.left = (x - 10) + 'px';
    d.style.top = (y - 10) + 'px';
    diagCont.appendChild(d);
  }
  document.getElementById('buscar-consulta').onclick = () => {
    const name = document.getElementById('consulta-petName').value.trim();
    const res = document.getElementById('consulta-result');
    if (!name) {
      res.textContent = 'Ingresa un nombre v√°lido';
      return;
    }
    res.innerHTML = `<p><strong>Mascota:</strong> ${name}</p><p><em>Datos simulados cargados</em></p>`;
    diagImg.src = mapaDiag['perro'];
    clearHotspots();
    diagCont.addEventListener('click', addHotspot);
  };

  // Toggle secci√≥n avanzada
  document.getElementById('toggle-avanzado').onclick = () => {
    const sec = document.getElementById('seccion-avanzada');
    sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
  };

  // Medicamentos
  const medsBody = document.querySelector('#tabla-meds-consulta tbody');
  function medSelectTemplate() {
    const s = document.createElement('select');
    s.name = 'medicamento[]';
    s.className = 'med-select';
    ['Antibi√≥tico 1', 'Medicamento 2', 'Medicamento 3'].forEach(m => {
      const o = document.createElement('option');
      o.value = o.textContent = m;
      s.appendChild(o);
    });
    return s;
  }
  function recalcConsultaTotal() {
    let t = 0;
    medsBody.querySelectorAll('tr').forEach(r => {
      const m = r.querySelector('.med-select').value;
      const p = { 'Antibi√≥tico 1': 250, 'Medicamento 2': 100, 'Medicamento 3': 150 }[m] || 0;
      r.querySelector('.price-cell').textContent = '$' + p.toFixed(2);
      t += p;
    });
    document.getElementById('total-consulta').textContent = t.toFixed(2);
  }
  document.getElementById('add-med').onclick = () => {
    const r = document.createElement('tr');
    r.innerHTML = `
      <td></td>
      <td><input name="dosage[]" placeholder="100 ml"/></td>
      <td><select name="route[]"><option>Oral</option><option>Intravenoso</option></select></td>
      <td class="price-cell">$0.00</td>
      <td><button type="button" class="button-86 btn-remove">Eliminar</button></td>`;
    r.querySelector('td:first-child').appendChild(medSelectTemplate());
    medsBody.appendChild(r);
    r.querySelector('.med-select').onchange = recalcConsultaTotal;
    r.querySelector('.btn-remove').onclick = () => { r.remove(); recalcConsultaTotal(); };
    recalcConsultaTotal();
  };
  medsBody.querySelectorAll('.med-select').forEach(s => s.onchange = recalcConsultaTotal);
  medsBody.querySelectorAll('.btn-remove').forEach(b => b.onclick = e => { e.target.closest('tr').remove(); recalcConsultaTotal(); });
  recalcConsultaTotal();

  document.getElementById('preview-receta').onclick = async () => {
    const cont = document.getElementById('receta-container');
    const tpl = await fetch('Receta.html').then(r => r.text());
    cont.innerHTML = tpl;
    cont.style.display = 'block';
  };
  document.getElementById('form-consulta').onsubmit = async e => {
    e.preventDefault();
    const cont = document.getElementById('receta-container');
    cont.style.display = 'block';
    const tpl = await fetch('Receta.html').then(r => r.text());
    cont.innerHTML = tpl;
  };
</script>
